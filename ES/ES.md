#  ES总结

##  倒排索引

倒排索引是区别于正排索引来说的，正排索引是从文档角度看其中的单词，表示每个文档都含有哪些单词、词频、位置。倒排索引则是从单词角度看文档，表示每个单词分别在那些文档中出现、词频、位置。

简单记为：

正排索引：文档 ---> 单词

倒排索引：单词 ---> 文档

创建倒排索引，主要分为以下几步：

1. 创建文档列表
   ![word_create](/Users/a/Desktop/hou-victor/images/ES/word_create.png)
2. 创建倒排索引列表，然后对数据进行分词，得到词条并编号
   ![word_index](/Users/a/Desktop/hou-victor/images/ES/word_index.png)
3. 搜索过程：当用户输入任意的词条时，首先对用户输入的数据进行分词，得到用户要搜索的所有词条，然后拿着这些词条去匹配，找到这些词条就可以找到包含词条的所有文档的编号，然后再根据编号去文档列表中找文档。



##  如何解决ES集群的脑裂问题

集群脑裂是指ES集群中的节点，一半支持Amaster，另一半支持Bmaster，导致集群进行分裂的情况。

当集群master候选数量不小于3个时，可以通过设置最少投票通过数量，超过所有候选节点一半以上来解决脑裂问题；当候选数量为两个时，只能修改为唯一的一个master候选，其它作为data节点，避免脑裂问题。

##  ES是如何实现master选举的

### 前置条件

1. 只有是候选节点（master：true）的节点才能成为主节点
2. 最小主节点数（min_master_nodes)的目的是为了防止脑裂

###  选举流程

获取主节点的核心入口为findMaster，选择主节点成功返回对应master，否则返回null。

1. 确认候选主节点数啊达标，elasticsearch.yml设置的值
2. 对所有候选主节点根据nodeId进行字典排序，每次选举每个节点都把自己知道的节点进行排序，然后选出第1个节点，认为是master节点
3. 如果对某个节点的投票数达到候选主节点数n / 2 + 1，并且该节点自己也选举自己，那么这个节点就是master，否则重新选举

ps：master节点的职责只要是对集群、节点、索引的管理



##  TODO

